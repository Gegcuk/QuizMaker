# Production Configuration for QuizMaker Backend
# This file will be copied to the container during deployment

# Database Configuration
spring.datasource.url=${SPRING_DATASOURCE_URL}
spring.datasource.username=${SPRING_DATASOURCE_USERNAME}
spring.datasource.password=${SPRING_DATASOURCE_PASSWORD}
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# JPA / Hibernate Configuration - Production mode with Flyway
spring.jpa.database-platform=org.hibernate.dialect.MySQL8Dialect
spring.jpa.hibernate.ddl-auto=validate
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.format_sql=false

# Logging Configuration (Production)
logging.level.org.springframework=INFO
logging.level.uk.gegc.quizmaker=INFO
logging.level.org.hibernate.SQL=WARN
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=WARN
logging.level.org.springframework.orm.jpa=WARN
logging.level.root=INFO

# JWT Configuration
jwt.secret=${JWT_SECRET}
jwt.access-expiration-ms=43200000
jwt.refresh-expiration-ms=604800000

# OpenAI Configuration
spring.ai.openai.api-key=${OPENAI_API_KEY}
spring.ai.openai.chat.options.model=${OPENAI_MODEL:gpt-4o-mini}

# CORS Configuration for Production
app.cors.allowed-origins=${FRONTEND_BASE_URL},https://quizzence.com,https://www.quizzence.com
app.cors.use-origin-patterns=false
app.cors.allowed-methods=GET,POST,PUT,PATCH,DELETE,OPTIONS,HEAD
app.cors.allowed-headers=Authorization,Content-Type,Accept,X-Requested-With,Origin,If-None-Match,Accept-Language
app.cors.exposed-headers=Location,Link,Content-Disposition,X-Total-Count,X-RateLimit-Limit,X-RateLimit-Remaining,X-RateLimit-Reset
app.cors.allow-credentials=true
app.cors.max-age=3600

# File Upload Configuration
spring.servlet.multipart.max-file-size=150MB
spring.servlet.multipart.max-request-size=150MB
spring.servlet.multipart.enabled=true

# Thread Pool Configuration (Production)
async.ai.core-pool-size=8
async.ai.max-pool-size=16
async.ai.queue-capacity=100
async.ai.keep-alive-seconds=60

async.general.core-pool-size=4
async.general.max-pool-size=8
async.general.queue-capacity=50
async.general.keep-alive-seconds=60

# Flyway Configuration - Enabled with proper repair
spring.flyway.enabled=true
spring.flyway.validate-on-migrate=false
spring.flyway.clean-disabled=false
spring.flyway.baseline-on-migrate=true
spring.flyway.out-of-order=true

# Feature flags (Production defaults)
quizmaker.features.share-links=true
quizmaker.features.organizations=true
quizmaker.features.billing=true

# Admin feature flags
app.admin.system-initialization.enabled=true

# Security Configuration
app.security.enable-forwarded-headers=true
app.security.trusted-proxies=127.0.0.1,::1,localhost

# Share Links security
quizmaker.share-links.token-pepper=${TOKEN_PEPPER_SECRET}

# Auth Configuration
app.auth.reset-token-ttl-minutes=60
app.auth.reset-token-pepper=${RESET_TOKEN_PEPPER}
app.auth.verification-token-ttl-minutes=1440
app.auth.verification-token-pepper=${VERIFICATION_TOKEN_PEPPER}

# Email Provider Configuration (Production - AWS SES)
app.email.provider=${APP_EMAIL_PROVIDER:ses}
app.email.from=${APP_EMAIL_FROM}
app.email.region=${APP_EMAIL_REGION:us-east-1}
app.email.ses.configuration-set=${APP_EMAIL_SES_CONFIGURATION_SET:}

# Legacy SMTP Configuration (commented out - use AWS SES instead)
# spring.mail.host=${SMTP_HOST}
# spring.mail.port=${SMTP_PORT}
# spring.mail.username=${SMTP_USERNAME}
# spring.mail.password=${SMTP_PASSWORD}
# spring.mail.properties.mail.smtp.auth=true
# spring.mail.properties.mail.smtp.starttls.enable=true
# spring.mail.properties.mail.smtp.starttls.required=true
# spring.mail.properties.mail.smtp.connectiontimeout=5000
# spring.mail.properties.mail.smtp.timeout=5000
# spring.mail.properties.mail.smtp.writetimeout=5000
# spring.mail.default-encoding=UTF-8

# Frontend Configuration
app.frontend.base-url=${FRONTEND_BASE_URL}

# Email Application Configuration
app.email.password-reset.subject=Password Reset Request - QuizMaker
app.email.verification.subject=Email Verification - QuizMaker

# Stripe Configuration
stripe.secret-key=${STRIPE_SECRET_KEY}
stripe.webhook-secret=${STRIPE_WEBHOOK_SECRET}
stripe.publishable-key=${STRIPE_PUBLISHABLE_KEY}
stripe.success-url=${FRONTEND_BASE_URL}/billing/success
stripe.cancel-url=${FRONTEND_BASE_URL}/billing/cancel
stripe.price.small=${STRIPE_PRICE_SMALL}
stripe.price.medium=${STRIPE_PRICE_MEDIUM}
stripe.price.large=${STRIPE_PRICE_LARGE}
stripe.price.subscription=${STRIPE_PRICE_SUBSCRIPTION}

# Additional relaxed-binding keys
stripe.priceSmall=${STRIPE_PRICE_SMALL}
stripe.priceMedium=${STRIPE_PRICE_MEDIUM}
stripe.priceLarge=${STRIPE_PRICE_LARGE}
stripe.priceSubscription=${STRIPE_PRICE_SUBSCRIPTION}

# Billing Configuration
billing.token-to-llm-ratio=${BILLING_TOKEN_TO_LLM_RATIO:1000}
billing.reservation-ttl-minutes=${BILLING_RESERVATION_TTL_MINUTES:120}
billing.reservation-sweeper-ms=${BILLING_RESERVATION_SWEEPER_MS:60000}
billing.safety-factor=${BILLING_SAFETY_FACTOR:1.2}
billing.currency=${BILLING_CURRENCY:usd}
billing.refund-policy=${BILLING_REFUND_POLICY:ALLOW_NEGATIVE_BALANCE}

# Document Processing Configuration
document.chunking.max-chunk-size=100000
document.chunking.min-chunk-size=1000
document.chunking.aggressive-combination-threshold=5000
document.chunking.default-strategy=CHAPTER_BASED

# DocumentProcess Configuration
docproc.normalization.dehyphenate=true
docproc.normalization.collapse-spaces=true
docproc.ai.default-model=gpt-4o-mini
docproc.ai.headroom-ratio=0.25

# Clock Configuration
app.timezone=UTC

# AI Rate Limiting Configuration
ai.rate-limit.max-retries=5
ai.rate-limit.base-delay-ms=1000
ai.rate-limit.max-delay-ms=60000
ai.rate-limit.jitter-factor=0.25

# Document Chunking Configuration
quizmaker.document.chunking.max-single-chunk-tokens=150000
quizmaker.document.chunking.max-single-chunk-chars=4000000
quizmaker.document.chunking.overlap-tokens=15000
quizmaker.document.chunking.model-max-tokens=400000
quizmaker.document.chunking.prompt-overhead-tokens=15000
quizmaker.document.chunking.aggressive-chunking=true
quizmaker.document.chunking.enable-emergency-chunking=true

# API Documentation
springdoc.api-docs.path=/api/v1/docs
springdoc.swagger-ui.path=/api/v1/docs/swagger-ui.html
springdoc.swagger-ui.url=/api/v1/docs

# Actuator Configuration
management.endpoints.web.exposure.include=health,info,metrics
management.endpoint.health.show-details=always
management.endpoint.health.show-components=always

# Enable Problem+JSON standardized errors
spring.mvc.problemdetails.enabled=true
