name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      # App secrets (masked). Provide test-safe defaults if not set.
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'test-noop' }}
      OPENAI_MODEL:   ${{ secrets.OPENAI_MODEL   || 'disabled' }}
      JWT_SECRET:     ${{ secrets.JWT_SECRET     || 'ci-test-secret' }}
      TOKEN_PEPPER_SECRET: ${{ secrets.TOKEN_PEPPER_SECRET || 'ci-test-pepper' }}
      SPRING_PROFILES_ACTIVE: test
      # Service containers with port mapping are accessible via localhost on the runner
      SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/quizmaker_test?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: bestuser
      SPRING_DATASOURCE_PASSWORD: bestuser
      
      # OAuth2 Configuration (tests use mocks, these are placeholders)
      OAUTH2_REDIRECT_URI: ${{ secrets.OAUTH2_REDIRECT_URI || 'http://localhost:3000/oauth2/redirect' }}
      OAUTH2_TOKEN_SECRET: ${{ secrets.OAUTH2_TOKEN_SECRET || 'lrPUVT2UZTcTqiRvLjrl0XWrnTl+BV5FEbSqxzXwKYE=' }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID || 'ci-test-google-client-id' }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET || 'ci-test-google-client-secret' }}
      OAUTH_GITHUB_CLIENT_ID: ${{ secrets.OAUTH_GITHUB_CLIENT_ID || 'ci-test-github-client-id' }}
      OAUTH_GITHUB_CLIENT_SECRET: ${{ secrets.OAUTH_GITHUB_CLIENT_SECRET || 'ci-test-github-client-secret' }}
      FACEBOOK_CLIENT_ID: ${{ secrets.FACEBOOK_CLIENT_ID || 'ci-test-facebook-client-id' }}
      FACEBOOK_CLIENT_SECRET: ${{ secrets.FACEBOOK_CLIENT_SECRET || 'ci-test-facebook-client-secret' }}
      MICROSOFT_CLIENT_ID: ${{ secrets.MICROSOFT_CLIENT_ID || 'ci-test-microsoft-client-id' }}
      MICROSOFT_CLIENT_SECRET: ${{ secrets.MICROSOFT_CLIENT_SECRET || 'ci-test-microsoft-client-secret' }}
      # Media / CDN (Spaces)
      MEDIA_BUCKET: ${{ secrets.MEDIA_BUCKET || 'quizzence' }}
      MEDIA_REGION: ${{ secrets.MEDIA_REGION || 'lon1' }}
      MEDIA_ENDPOINT: ${{ secrets.MEDIA_ENDPOINT || 'https://lon1.digitaloceanspaces.com' }}
      MEDIA_CDN_BASE_URL: ${{ secrets.MEDIA_CDN_BASE_URL || 'https://cdn.quizzence.com' }}
      DO_SPACES_ACCESS_KEY: ${{ secrets.DO_SPACES_ACCESS_KEY || 'ci-access-key' }}
      DO_SPACES_SECRET_KEY: ${{ secrets.DO_SPACES_SECRET_KEY || 'ci-secret-key' }}
      MEDIA_UPLOAD_URL_TTL: ${{ secrets.MEDIA_UPLOAD_URL_TTL || 'PT15M' }}
      MEDIA_MAX_IMAGE_SIZE_BYTES: ${{ secrets.MEDIA_MAX_IMAGE_SIZE_BYTES || '20971520' }}
      MEDIA_MAX_DOC_SIZE_BYTES: ${{ secrets.MEDIA_MAX_DOC_SIZE_BYTES || '20971520' }}
      MEDIA_DELETE_REMOTE: ${{ secrets.MEDIA_DELETE_REMOTE || 'false' }}
      MEDIA_ARTICLE_PREFIX: ${{ secrets.MEDIA_ARTICLE_PREFIX || 'articles' }}
      MEDIA_LIBRARY_PREFIX: ${{ secrets.MEDIA_LIBRARY_PREFIX || 'library' }}

    services:
      mysql:
        image: mysql:8.4  # LTS line
        ports:
          - 3306:3306
        env:
          MYSQL_DATABASE: quizmaker_test
          MYSQL_USER: bestuser
          MYSQL_PASSWORD: bestuser
          MYSQL_ROOT_PASSWORD: root
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot --silent"
          --health-interval=10s --health-timeout=5s --health-retries=10

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Check MySQL container status
        run: |
          echo "üîç Checking MySQL service container status..."
          echo ""
          echo "Docker containers:"
          docker ps -a | grep -i mysql || echo "  ‚ö†Ô∏è No MySQL containers found"
          echo ""
          echo "Docker network:"
          docker network ls | grep -E "bridge|github" || echo "  ‚ö†Ô∏è No relevant networks found"
          echo ""
          echo "Checking for MySQL service container..."
          # Try to get service container info
          MYSQL_CONTAINER=$(docker ps -a --filter "name=mysql" --format "{{.ID}}" | head -1)
          if [ -n "$MYSQL_CONTAINER" ]; then
            echo "‚úÖ Found MySQL container: $MYSQL_CONTAINER"
            echo ""
            echo "Container status:"
            docker ps -a --filter "id=$MYSQL_CONTAINER" --format "table {{.ID}}\t{{.Status}}\t{{.Names}}\t{{.Ports}}"
            echo ""
            echo "MySQL container logs (last 30 lines):"
            docker logs --tail=30 "$MYSQL_CONTAINER" 2>&1 || echo "  ‚ö†Ô∏è Cannot read container logs"
          else
            echo "‚ö†Ô∏è MySQL container not found yet (this is normal if it's still starting)"
          fi
          echo ""
          echo "Checking if port 3306 is listening on localhost:"
          netstat -an | grep 3306 || ss -an | grep 3306 || echo "  ‚ö†Ô∏è Port 3306 not listening yet"

      - name: Wait for MySQL to be healthy
        run: |
          set +e  # Disable exit on error since we handle failures explicitly
          echo "Waiting for MySQL service to be ready (accessible via localhost:3306)..."
          echo ""
          
          # Function to show MySQL container logs
          show_mysql_logs() {
            MYSQL_CONTAINER=$(docker ps -a --filter "name=mysql" --format "{{.ID}}" | head -1)
            if [ -n "$MYSQL_CONTAINER" ]; then
              echo "üìã MySQL container logs (last 10 lines):"
              docker logs --tail=10 "$MYSQL_CONTAINER" 2>&1 | sed 's/^/  /' || true
            fi
          }
          
          # Wait a moment for MySQL to fully initialize after health check passes
          echo "‚è≥ Waiting 5 seconds for MySQL to fully initialize..."
          sleep 5
          
          # Check if mysqladmin is available (might not be installed in runner)
          if command -v mysqladmin >/dev/null 2>&1; then
            echo "‚úÖ MySQL client tools available"
            MYSQL_READY=0
            for i in {1..60}; do
              # Try to ping MySQL and show error if it fails
              PING_OUTPUT=$(mysqladmin ping -h localhost -uroot -proot 2>&1)
              PING_STATUS=$?
              
              if [ $PING_STATUS -eq 0 ]; then
                echo "‚úÖ MySQL is ready!"
                # Verify we can actually connect and query
                QUERY_OUTPUT=$(mysql -h localhost -uroot -proot -e "SELECT 1;" 2>&1)
                QUERY_STATUS=$?
                if [ $QUERY_STATUS -eq 0 ]; then
                  echo "‚úÖ MySQL connection verified!"
                  MYSQL_READY=1
                  break
                else
                  echo "‚ö†Ô∏è mysqladmin ping succeeded but mysql query failed"
                  echo "$QUERY_OUTPUT" | head -3
                fi
              else
                # Show error on first attempt and every 10th attempt
                if [ $i -eq 1 ] || [ $((i % 10)) -eq 0 ]; then
                  echo "‚ö†Ô∏è mysqladmin ping failed (attempt $i/60)"
                  echo "Error: $PING_OUTPUT"
                  echo ""
                fi
              fi
              
              # Show logs periodically
              if [ $((i % 10)) -eq 0 ]; then
                echo "Still waiting for MySQL... (attempt $i/60)"
                show_mysql_logs
                echo ""
                echo "Checking container status:"
                docker ps -a | grep -i mysql | head -1 || echo "  Container not found"
                echo ""
                echo "Testing port connectivity:"
                timeout 2 bash -c 'cat < /dev/null > /dev/tcp/localhost/3306' 2>/dev/null && echo "  ‚úÖ Port 3306 is accessible" || echo "  ‚ùå Port 3306 not accessible"
                echo ""
                echo "Testing connection from inside container:"
                MYSQL_CONTAINER=$(docker ps -a --filter "name=mysql" --format "{{.ID}}" | head -1)
                if [ -n "$MYSQL_CONTAINER" ]; then
                  docker exec "$MYSQL_CONTAINER" mysqladmin ping -h localhost -uroot -proot 2>&1 && echo "  ‚úÖ Container internal connection works" || echo "  ‚ùå Container internal connection failed"
                fi
                echo ""
              fi
              
              sleep 2
            done
            
            # Final verification if we didn't succeed in the loop
            if [ $MYSQL_READY -eq 0 ]; then
              mysqladmin ping -h localhost -uroot -proot --silent 2>&1
              if [ $? -ne 0 ]; then
                echo "‚ùå MySQL failed to become ready after 2 minutes"
                echo ""
                echo "Diagnostics:"
                echo "MySQL container status:"
                docker ps -a | grep -i mysql || echo "  ‚ö†Ô∏è Container not found"
                echo ""
                echo "MySQL container logs (last 50 lines):"
                MYSQL_CONTAINER=$(docker ps -a --filter "name=mysql" --format "{{.ID}}" | head -1)
                if [ -n "$MYSQL_CONTAINER" ]; then
                  docker logs --tail=50 "$MYSQL_CONTAINER" 2>&1 || echo "  ‚ö†Ô∏è Cannot read logs"
                else
                  echo "  ‚ö†Ô∏è Container not found"
                fi
                echo ""
                echo "Testing connection with mysqladmin:"
                mysqladmin ping -h localhost -uroot -proot 2>&1 || echo "  ‚ùå mysqladmin ping failed"
                echo ""
                echo "Testing connection with mysql client:"
                mysql -h localhost -uroot -proot -e "SELECT 1;" 2>&1 || echo "  ‚ùå mysql query failed"
                echo ""
                echo "Port connectivity:"
                timeout 2 bash -c 'cat < /dev/null > /dev/tcp/localhost/3306' 2>/dev/null && echo "  ‚úÖ Port 3306 accessible" || echo "  ‚ùå Port 3306 not accessible"
                echo ""
                echo "Trying to connect from inside the container:"
                docker exec "$MYSQL_CONTAINER" mysqladmin ping -h localhost -uroot -proot 2>&1 || echo "  ‚ùå Container exec failed"
                exit 1
              else
                MYSQL_READY=1
              fi
            fi
          else
            echo "‚ö†Ô∏è MySQL client tools not found - using TCP connection test"
            MYSQL_READY=0
            for i in {1..60}; do
              timeout 2 bash -c 'cat < /dev/null > /dev/tcp/localhost/3306' 2>/dev/null
              if [ $? -eq 0 ]; then
                echo "‚úÖ MySQL port 3306 is accessible!"
                MYSQL_READY=1
                break
              fi
              
              # Show logs periodically
              if [ $((i % 10)) -eq 0 ]; then
                echo "Still waiting for MySQL... (attempt $i/60)"
                show_mysql_logs
                echo ""
              fi
              
              sleep 2
            done
            
            # Final verification if we didn't succeed in the loop
            if [ $MYSQL_READY -eq 0 ]; then
              timeout 2 bash -c 'cat < /dev/null > /dev/tcp/localhost/3306' 2>/dev/null
              if [ $? -ne 0 ]; then
                echo "‚ùå MySQL port 3306 not accessible after 2 minutes"
                echo ""
                echo "Diagnostics:"
                echo "MySQL container status:"
                docker ps -a | grep -i mysql || echo "  ‚ö†Ô∏è Container not found"
                echo ""
                echo "MySQL container logs (last 50 lines):"
                MYSQL_CONTAINER=$(docker ps -a --filter "name=mysql" --format "{{.ID}}" | head -1)
                if [ -n "$MYSQL_CONTAINER" ]; then
                  docker logs --tail=50 "$MYSQL_CONTAINER" 2>&1 || echo "  ‚ö†Ô∏è Cannot read logs"
                else
                  echo "  ‚ö†Ô∏è Container not found"
                fi
                echo ""
                echo "Checking if port is listening:"
                netstat -an | grep 3306 || ss -an | grep 3306 || echo "  ‚ö†Ô∏è Port 3306 not found"
                exit 1
              else
                MYSQL_READY=1
              fi
            fi
          fi
          
          # Final success message
          if [ ${MYSQL_READY:-0} -eq 1 ]; then
            echo "‚úÖ MySQL is ready and accessible!"
            echo ""
            echo "Final MySQL container status:"
            docker ps -a | grep -i mysql | head -1 || echo "  Container not found"
            echo ""
            echo "MySQL container logs (last 10 lines):"
            show_mysql_logs
            exit 0
          else
            echo "‚ùå MySQL readiness check failed"
            exit 1
          fi

      - name: Flyway migrate (fail fast on schema issues)
        run: |
          ./mvnw -B -V -q -DskipTests=true \
            -Dflyway.url="$SPRING_DATASOURCE_URL" \
            -Dflyway.user="$SPRING_DATASOURCE_USERNAME" \
            -Dflyway.password="$SPRING_DATASOURCE_PASSWORD" \
            flyway:migrate | cat

      - name: Run tests
        run: ./mvnw -B -T 1C -DskipTests=false test | cat

      - name: Upload surefire reports on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: |
            **/target/surefire-reports/**
            **/target/failsafe-reports/**
